name: Check agent-examples

on: [pull_request, workflow_dispatch]

jobs:
  run-agent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Clone into test directory
        run: |
          git clone . test-dir
          cd test-dir

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.17.0"
          cache: "yarn"
          cache-dependency-path: "test-dir/yarn.lock"

      - name: Install dependencies
        run: |
          cd test-dir
          yarn install

      - name: Generate keys and set env
        run: |
          cd test-dir/examples/xmtp-gm
          touch .env
          yarn gen:keys

      - name: Run agent
        run: |
          cd test-dir/examples/xmtp-gm
          timeout 20s yarn dev | tee output.log
          if grep -q "Waiting for messages..." output.log; then
            echo "Success: Agent started successfully and is waiting for messages"
            exit 0
          else
            echo "Error: Agent did not reach 'Waiting for messages...' state"
            exit 1
          fi
